{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "58f1a948_c4de36c0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 15
      },
      "lineNbr": 0,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2023-05-13T13:08:44Z",
      "side": 1,
      "message": "I think this is the right approach @Alvaro, well done üëç\nThe only thing I am still thinking about is this cache value as `boolean`:\n\nI think it is misleading.\nWhat would it mean for the cache to have a `false` value?\n\nIdeally, this would be a set rather than a map, but I don\u0027t think there\u0027s any class modelling a set with TTL:\n\nA couple of alternatives could be:\n- use the key _as_ the value.\n- use a DUMMY static value.\n\nWDYT?",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a56ddd25_2b37f8e4",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 15
      },
      "lineNbr": 0,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-05-16T16:35:40Z",
      "side": 1,
      "message": "\u003e What would it mean for the cache to have a false value?\n\nThat case is not possible, is always (key, true). You are right that it is very misleading and it needs to be revisit.\n\n\n\u003e A couple of alternatives could be:\n\u003e use the key as the value.\n \n  Can we have a cache where the internal data structure is a Set?\n  \n\u003e use a DUMMY static value.\n  \n  Can we end up with the same problem as the boolean?",
      "parentUuid": "58f1a948_c4de36c0",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "91c5d80a_9d5a1e22",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 15
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-17T21:30:32Z",
      "side": 1,
      "message": "Good stuff @alvaro.vilaplana@gmail.com, see my comments.",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "329aad02_1d077cc5",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/ApplyObjectCacheModule.java",
        "patchSetId": 15
      },
      "lineNbr": 10,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2023-05-16T08:31:50Z",
      "side": 1,
      "message": "this cache should have short ttl? Could we add some defaults let say expiration time to one minute",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6d3e1f1c_487b687f",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/ApplyObjectCacheModule.java",
        "patchSetId": 15
      },
      "lineNbr": 10,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-05-16T16:35:40Z",
      "side": 1,
      "message": "I added a comment earlier:\n```\nI have created the logic to insert/find in the apply-objects cache. Please have a look at it.\n\nTODO:\n\nConfigure the cache programatically\nE2E\nAdd documentation about new cache\n```\n\nThe idea is configure the cache with TTL i.e 1 minute. All that part is not implemented yet. I am waiting feedback about the approach.",
      "parentUuid": "329aad02_1d077cc5",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "da47d307_b9406e05",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/ApplyObjectCacheModule.java",
        "patchSetId": 15
      },
      "lineNbr": 10,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2023-05-17T07:17:44Z",
      "side": 1,
      "message": "I think you approach is correct üòä",
      "parentUuid": "6d3e1f1c_487b687f",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "35e73f4e_8b70337b",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/ApplyObjectCacheModule.java",
        "patchSetId": 15
      },
      "lineNbr": 10,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-17T21:30:32Z",
      "side": 1,
      "message": "The configuration is a NTH, but not necessarily needed. There is no value in having longer values anyway.",
      "parentUuid": "da47d307_b9406e05",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1981bbc5_d72e16bc",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/ApplyObjectsCacheKey.java",
        "patchSetId": 15
      },
      "lineNbr": 12,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2023-05-16T08:31:50Z",
      "side": 1,
      "message": "maybe rev or sha1 would be a better name?",
      "range": {
        "startLine": 12,
        "startChar": 25,
        "endLine": 12,
        "endChar": 31
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a530ddf1_4fb253a4",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/ApplyObjectsCacheKey.java",
        "patchSetId": 15
      },
      "lineNbr": 12,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-05-16T16:35:40Z",
      "side": 1,
      "message": "Happy to change if makes it more descriptive.",
      "parentUuid": "1981bbc5_d72e16bc",
      "range": {
        "startLine": 12,
        "startChar": 25,
        "endLine": 12,
        "endChar": 31
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7c4bd4e9_c2032a8a",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/ApplyObjectsCacheKey.java",
        "patchSetId": 15
      },
      "lineNbr": 12,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-17T21:30:32Z",
      "side": 1,
      "message": "objectId?",
      "parentUuid": "a530ddf1_4fb253a4",
      "range": {
        "startLine": 12,
        "startChar": 25,
        "endLine": 12,
        "endChar": 31
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d271f1f9_5e4c677f",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/ApplyObjectsCacheKey.java",
        "patchSetId": 15
      },
      "lineNbr": 16,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-17T21:30:32Z",
      "side": 1,
      "message": "Missing the event timestamp.",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e41fa37e_e72bb73b",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/api/ApplyObjectCommand.java",
        "patchSetId": 15
      },
      "lineNbr": 47,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-17T21:30:32Z",
      "side": 1,
      "message": "What is this for?",
      "range": {
        "startLine": 47,
        "startChar": 44,
        "endLine": 47,
        "endChar": 51
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2f33c080_88cad8a6",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/api/ApplyObjectCommand.java",
        "patchSetId": 15
      },
      "lineNbr": 47,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-23T18:26:46Z",
      "side": 1,
      "message": "I\u0027ve changed it to the timestamp of the ref-update event, so that we can use it to consider as __done__ all the apply objects for that ref and \u003c\u003d of that time.",
      "parentUuid": "e41fa37e_e72bb73b",
      "range": {
        "startLine": 47,
        "startChar": 44,
        "endLine": 47,
        "endChar": 51
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2752cda6_5f366ccc",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/api/ApplyObjectCommand.java",
        "patchSetId": 15
      },
      "lineNbr": 96,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-17T21:30:32Z",
      "side": 1,
      "message": "Why only the last one? If the apply-objects has succeeded, I believe we should remember that all SHA1s have been applied to that ref. Any attempt to fetch any of them should be discarded, if they match the same event timestamp.",
      "range": {
        "startLine": 96,
        "startChar": 38,
        "endLine": 96,
        "endChar": 77
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a67db08b_143b9184",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/api/ApplyObjectCommand.java",
        "patchSetId": 15
      },
      "lineNbr": 96,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-23T18:26:46Z",
      "side": 1,
      "message": "Also, it would be best to apply on the ApplyObject command, so that we have the exact status of the execution for each one of them.",
      "parentUuid": "2752cda6_5f366ccc",
      "range": {
        "startLine": 96,
        "startChar": 38,
        "endLine": 96,
        "endChar": 77
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2d90631b_18b39a72",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/api/ApplyObjectCommand.java",
        "patchSetId": 15
      },
      "lineNbr": 99,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2023-05-16T08:31:50Z",
      "side": 1,
      "message": "why sha1 is a part of the key? Should this be a value and key should contain only refName and project name? Is this because we want to tract all apply objects which happened for that ref not only the last one?",
      "range": {
        "startLine": 99,
        "startChar": 14,
        "endLine": 99,
        "endChar": 58
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "80937793_31970127",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/api/ApplyObjectCommand.java",
        "patchSetId": 15
      },
      "lineNbr": 99,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-05-16T16:35:40Z",
      "side": 1,
      "message": "Maybe the way I have model Cache\u003cKey,Value\u003e is a bit misleading.\nThe way I understood it is like a `composite key (Sha1, refName, projectName)` and when there is an event `RefUpdatedEvent` consumed by `StreamEventListener` that contains an entry in the cache with those values then it is discarded. \n\nLets have a talk about that.",
      "parentUuid": "2d90631b_18b39a72",
      "range": {
        "startLine": 99,
        "startChar": 14,
        "endLine": 99,
        "endChar": 58
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4e200b58_87021ca9",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/api/ApplyObjectCommand.java",
        "patchSetId": 15
      },
      "lineNbr": 99,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2023-05-17T07:17:44Z",
      "side": 1,
      "message": "I think your approach is correct I just wanted to confirm if this was the intention",
      "parentUuid": "80937793_31970127",
      "range": {
        "startLine": 99,
        "startChar": 14,
        "endLine": 99,
        "endChar": 58
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5ee16a0e_24b9361b",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/api/ApplyObjectCommand.java",
        "patchSetId": 15
      },
      "lineNbr": 99,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-17T21:30:32Z",
      "side": 1,
      "message": "I believe the `sha1` is definitely needed (the same ref could be updated more than once in a rapid sequence with different `sha1` values) and also the timestamp of the event.\n\nTo recap:\n- Event timestamp to add to the key\n- Store *ALL* SHA1s as separate entries, to remember that the ref has been applied to all those SHA1s.",
      "parentUuid": "4e200b58_87021ca9",
      "range": {
        "startLine": 99,
        "startChar": 14,
        "endLine": 99,
        "endChar": 58
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "57d4c2bb_6664a72c",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/api/ApplyObjectCommand.java",
        "patchSetId": 15
      },
      "lineNbr": 100,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-17T21:30:32Z",
      "side": 1,
      "message": "This means nothing IMHO. Can we put something else more meaningful or just nothing? (Void)",
      "range": {
        "startLine": 100,
        "startChar": 10,
        "endLine": 100,
        "endChar": 14
      },
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6e5ab458_6774a374",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/event/StreamEventListener.java",
        "patchSetId": 15
      },
      "lineNbr": 133,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2023-05-15T13:44:15Z",
      "side": 1,
      "message": "Is it possible that we process the refs via the `StreamEventListener` before the apply object? I am thinking about any slowness related to the HTTP connection.\n\nIn that can we should cache the value here and check on the apply object side.",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "db41a216_3a4bfa9d",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/event/StreamEventListener.java",
        "patchSetId": 15
      },
      "lineNbr": 133,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-05-16T16:35:40Z",
      "side": 1,
      "message": "Good question. What I understood is that when there is an `Gerrit Event` published in the `Gerrit event bus` all the listeners will consumed the event sequentially and in this case the listener that makes the `Apply object HTTP request` is before that the `events-kafka` plus I think that request is blocking so there is no way that the event is consumed earlier.\n\n@luca.milanesio@gmail.com / @syntonyze@gmail.com can you confirm that? \nIf I am not correct then we need to revisit the ACs.",
      "parentUuid": "6e5ab458_6774a374",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2ba19fa9_3bcebdf5",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/event/StreamEventListener.java",
        "patchSetId": 15
      },
      "lineNbr": 133,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-17T21:30:32Z",
      "side": 1,
      "message": "It is *NOT* possible that the event would come before the apply-object: the invocation of the ref-update listeners is sync and the apply-object won\u0027t release the control to the next listener until it is completed (or failed).",
      "parentUuid": "db41a216_3a4bfa9d",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7f129cd2_5c8d1dab",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/event/StreamEventListener.java",
        "patchSetId": 15
      },
      "lineNbr": 224,
      "author": {
        "id": 1054778
      },
      "writtenOn": "2023-05-15T13:44:15Z",
      "side": 1,
      "message": "How does the cache invalidation happen at the moment?\n\nI was wondering if it makes sense to invalidate the cache here, since at this stage we know it won\u0027t be needed anymore, right?\n\nThis way we will keep it as small as possible.\n\nFurthermore, if we decide to invalidate it here, maybe we don\u0027t even need a cache anymore, but a simple in-memory `Set` would be enough. WDYT?",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "678c2ba0_cc111daf",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/event/StreamEventListener.java",
        "patchSetId": 15
      },
      "lineNbr": 224,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2023-05-16T08:31:50Z",
      "side": 1,
      "message": "We don\u0027t know if we don\u0027t need it anymore. We still can have applyObject or different node for some reason can send us event for the same ref version",
      "parentUuid": "7f129cd2_5c8d1dab",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e8e0dcc5_4a742d45",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/event/StreamEventListener.java",
        "patchSetId": 15
      },
      "lineNbr": 224,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-05-16T16:35:40Z",
      "side": 1,
      "message": "\u003e How does the cache invalidation happen at the moment?\n\nThe invalidation will be part of the configuration of the cache, i.e after 60 seconds then entry will be removed\n\n\u003e I was wondering if it makes sense to invalidate the cache here, since at this stage we know it won\u0027t be needed anymore, right?\n\nI would leave that responsibility to the cache itself. For instance what would happen if the event is duplicated? I guess that we want to keep ignoring it.\n\n\u003e We don\u0027t know if we don\u0027t need it anymore. We still can have applyObject or different node for some reason can send us event for the same ref version\n\n@maczech@gmail.com what do you mean?",
      "parentUuid": "678c2ba0_cc111daf",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fc784bdf_6bb09140",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/event/StreamEventListener.java",
        "patchSetId": 15
      },
      "lineNbr": 224,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2023-05-17T07:17:44Z",
      "side": 1,
      "message": "As you mentioned cache entry should be removed by ttl not explicitly from the code because we don\u0027t know if all operations(apply object/fetch) are done for that ref",
      "parentUuid": "e8e0dcc5_4a742d45",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "161e639e_e648b3d2",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/event/StreamEventListener.java",
        "patchSetId": 15
      },
      "lineNbr": 224,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-05-17T21:30:32Z",
      "side": 1,
      "message": "+1, we should not invalidate anything, just let the items expire by maxAge.",
      "parentUuid": "fc784bdf_6bb09140",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "debd0f55_1caf8673",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/event/StreamEventListener.java",
        "patchSetId": 15
      },
      "lineNbr": 224,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-05-18T09:43:08Z",
      "side": 1,
      "message": "Makes sense to me.",
      "parentUuid": "161e639e_e648b3d2",
      "revId": "e1e6704eaa113a40a71774a41cb1b1364327084f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}