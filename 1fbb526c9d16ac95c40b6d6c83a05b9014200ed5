{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "613195c3_c9de4272",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-04T11:55:10Z",
      "side": 1,
      "message": "Adding a -1 because of two things missing:\n1. Documentation update (the missing \u0027fetch\u0027 would also trigger a push replication if the replication plugin is there)\n2. Introduction of a default value for the \u0027fetch\u0027 configuration",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "6717c809_6b403be0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-01-04T13:21:40Z",
      "side": 1,
      "message": "\u003e Introduction of a default value for the \u0027fetch\u0027 configuration\n\nThre\u0027s already a default `ref/*:ref/*` in the `replication` plugin, should we use the same here?",
      "parentUuid": "613195c3_c9de4272",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "049ba0c0_1d640572",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-04T13:26:15Z",
      "side": 1,
      "message": "\u003e \u003e Introduction of a default value for the \u0027fetch\u0027 configuration\n\u003e \n\u003e Thre\u0027s already a default `ref/*:ref/*` in the `replication` plugin, should we use the same here?\n\n+1",
      "parentUuid": "6717c809_6b403be0",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "18e66356_f74197b3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-01-04T18:44:45Z",
      "side": 1,
      "message": "The default value on replicas feels like a separate feature, I\u0027ll update the documentation on this one and open a follow-up change with the default value.",
      "parentUuid": "049ba0c0_1d640572",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b7dd38b8_a4a4df84",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/SourceConfigParser.java",
        "patchSetId": 1
      },
      "lineNbr": 89,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2023-12-15T10:46:58Z",
      "side": 1,
      "message": "Unfortunately, the push replication and pull replication configs are tightly coupled (see my explanation on [1], if you haven\u0027t already).\n\nNot having a `fetch` configuration in the `replication.config` might have a side effect on the `push` replication.\n\nI think this change will work, but only when the `url` is also not specified (thanks to [2]).\n\nIf the URL is not specified, then the `DestinationConfigParser` will ignore the destination, no problem [3].\n\nIf the URL _is_ specified, and the `fetch` is too, the `DestinationConfigParser` will correctly ignore the remote [4], since it is a source configuration, no problem.\n\nIf the URL _is_ specified but the `fetch` isn\u0027t (as this change allows to do), a problem will occur: `DestinationConfigParser` will assume `push \u003d refs/*:refs/*` [5], which is wrong.\n\nCould you please verify, if you haven\u0027t already, that this is the case?\n\nHappy to catch up to clarify things and discuss options.\n\n[1]https://issues.gerritcodereview.com/issues/40015281#comment5\n[2] https://gerrit-review.googlesource.com/c/plugins/pull-replication/+/373627\n[3] https://gerrit.googlesource.com/plugins/replication/+/refs/heads/master/src/main/java/com/googlesource/gerrit/plugins/replication/DestinationConfigParser.java#55\n[4] https://gerrit.googlesource.com/plugins/replication/+/refs/heads/master/src/main/java/com/googlesource/gerrit/plugins/replication/DestinationConfigParser.java#59\n[5] https://gerrit.googlesource.com/plugins/replication/+/refs/heads/master/src/main/java/com/googlesource/gerrit/plugins/replication/DestinationConfigParser.java#71",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "76bd980d_1d649361",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/SourceConfigParser.java",
        "patchSetId": 1
      },
      "lineNbr": 89,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2023-12-18T11:52:20Z",
      "side": 1,
      "message": "After discussing this offline, it turned out that this change will change how the `replication` plugin behaves, **but** this is a rare corner case, let me explain.\n\nFirst of all, you need to have **both** `replication` and `pull-replication` plugins installed at the same time. Both would use `$gerrit_site/etc/replication.config` file to get the remote configuration. Let\u0027s assume that we have a remote configured as follows:\n```\n[remote \"backup\"]\n  url: https://gerrit@backup.system.com/\n  apiUrl: https://backup.system.com/\n  fetch: refs/*:refs/*\n```\nthe `replication` plugin would discover that this is a `push-replication` remote and will completely ignore it.\nNow, **assuming** this change is merged, The configuration can be updated to:\n```\n[remote \"backup\"]\n  url: https://gerrit@backup.system.com/\n  apiUrl: https://backup.system.com/\n```\nThis means, that the `replication` plugin will recognize it as a valid remote, it will assume the default `push` configuration as `refs/*:refs/*`. And will start pushing updates to it.\n\nI can see three possible solutions for this:\n1. document this behaviour, put it into release notes and emit a warning when it\u0027s detected - IMO this is the least user-friendly, as it requires user action and also assumes that someone will have a look at logs/changelog/documentation.\n2. in the `replication` plugin check for `apiUrl` and ignore such remote - the downside is that the `replication` plugin will become _aware_ of the `pull-replication` which from the design perspective may not be desired\n3. declare this issue as _won\u0027t fix_ as the fix affects the `replication` plugin\n\nI\u0027m leaning more toward #2 or #3, solutions. WDYT @syntonyze@gmail.com @luca.milanesio@gmail.com",
      "parentUuid": "b7dd38b8_a4a4df84",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e55cf80f_f994b489",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/SourceConfigParser.java",
        "patchSetId": 1
      },
      "lineNbr": 89,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2023-12-30T01:44:04Z",
      "side": 1,
      "message": "We want to avoid adding `fetch` in replicas, as documented in Issue 40015281, isn\u0027t it?\n\nReplicas do not support the replication plugin, because they would never ever accept any updates.\n\nThe scenario therefore where we do not have `fetch` (replicas) and the replication plugin things this is a push target just does not exist.\n\n@syntonyze@gmail.com do you see any other gothas?",
      "parentUuid": "76bd980d_1d649361",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8848b026_be219d51",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/SourceConfigParser.java",
        "patchSetId": 1
      },
      "lineNbr": 89,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2024-01-04T11:20:17Z",
      "side": 1,
      "message": "\u003e We want to avoid adding fetch in replicas, as documented in Issue 40015281, isn\u0027t it?\n\n@luca.milanesio@gmail.com I think is the opposite. In primary we want to make sure that we will never fetch from replica so we want to remove `url` and `fetch` params but still be able to send apply object or fetch rest api calls. You can see it in the code in L89:\n```\n if (!isReplica || !remoteConfig.getFetchRefSpecs().isEmpty()) {\n```\nif we are not replica we don\u0027t care if fetch refs spec is empty or not.\n\nOn primary having pull and push replication plugins together is a valid use case. This means that point 5 from @syntonyze@gmail.com comment is valid. If on primary someone remove `fetch` but keep url it will be treated as valid push replication destination with `refs/*:refs/*` refspec",
      "parentUuid": "e55cf80f_f994b489",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "33652c62_bda26fbb",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/SourceConfigParser.java",
        "patchSetId": 1
      },
      "lineNbr": 89,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-04T11:54:27Z",
      "side": 1,
      "message": "\u003e \u003e We want to avoid adding fetch in replicas, as documented in Issue 40015281, isn\u0027t it?\n\u003e \n\u003e @luca.milanesio@gmail.com I think is the opposite. In primary we want to make sure that we will never fetch from replica so we want to remove `url` and `fetch` params but still be able to send apply object or fetch rest api calls. You can see it in the code in L89:\n\u003e ```\n\u003e  if (!isReplica || !remoteConfig.getFetchRefSpecs().isEmpty()) {\n\u003e ```\n\u003e if we are not replica we don\u0027t care if fetch refs spec is empty or not.\n\n+1\n\n\u003e On primary having pull and push replication plugins together is a valid use case.\n\nTrue.\n\n\u003e This means that point 5 from @syntonyze@gmail.com comment is valid. If on primary someone remove `fetch` but keep url it will be treated as valid push replication destination with `refs/*:refs/*` refspec.\n\nTrue, but this is master and therefore it is just something we want to make the Gerrit admin aware of. Why not just adding a note to the documentation with that?\n\nWe also need to make sure that `replication.\u003cremote\u003e.fetch` has a default value, as the replication plugin has. The fetch configuration also determines if a replication should happen or not with a specific ref. If fetch is empty, then we need to define and document a default value.",
      "parentUuid": "8848b026_be219d51",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9d914489_3987d7d1",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/SourceConfigParser.java",
        "patchSetId": 1
      },
      "lineNbr": 89,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-04T19:19:33Z",
      "side": 1,
      "message": "Marking this as clarified.",
      "parentUuid": "33652c62_bda26fbb",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "846bdf2e_908e2b1b",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/SourceConfigParser.java",
        "patchSetId": 1
      },
      "lineNbr": 89,
      "author": {
        "id": 1157810
      },
      "writtenOn": "2024-01-09T09:48:45Z",
      "side": 1,
      "message": "Just to add my 2p, I don\u0027t understand why we are opening this up to misconfiguration. \n\n\u003e but this is master and therefore it is just something we want to make the Gerrit admin aware of. Why not just adding a note to the documentation with that?\n\nIf I am not mistaken, there are no release notes for the plugin, so how will the Gerrit admin become aware of this change?",
      "parentUuid": "9d914489_3987d7d1",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "7afe6192_9c695a69",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/replication/pull/SourceConfigParser.java",
        "patchSetId": 1
      },
      "lineNbr": 89,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2024-01-15T09:05:33Z",
      "side": 1,
      "message": "Release notes are only available for core plugins and pull-replication is not one of them at this stage.\n\nThe approach for Gerrit admins is to go through plugin changes and to test them as part of their cut over plan.",
      "parentUuid": "846bdf2e_908e2b1b",
      "revId": "1fbb526c9d16ac95c40b6d6c83a05b9014200ed5",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}